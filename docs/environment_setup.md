#### **Настройка тестового окружения**
1) Установка ПО на компьютер (только для настройки некоторых параметров станций и удобного просмотра).
    - Тестовая программа для работы со станциями из Windows - https://github.com/realtim/mmb/blob/master/BTStation/RFID_Station_control_win.rar
    - Тестовая программа для работы со станциями из Android (>= 6.0) - https://github.com/realtim/mmb/blob/master/BTStation/RfidStationControl-Signed-Android6-release.apk
    - Arduino IDE последней версии (можно портабельный ZIP) - https://www.arduino.cc/en/Main/Software
    - библиотеки для сборки прошивки - https://github.com/realtim/mmb/blob/master/BTStation/libraries.zip
    - исходник боевой прошивки - https://github.com/realtim/mmb/blob/master/BTStation/BTStation.rar
    - исходник прошивки для тестирования чипов - https://github.com/realtim/mmb/blob/master/BTStation/BTStation_test.ino

Все ПО можно найти на https://github.com/realtim/mmb/tree/master/BTStation
    Если нужны драйвера для USB-UART адаптера:
    - CP210x - https://www.silabs.com/products/development-tools/software/usb-to-uart-bridge-vcp-drivers
    - CH340 - https://sparks.gogo.co.nz/ch340.html
    - PL2303 - http://www.miklor.com/COM/UV_Drivers.php

2) Прошивка станции из Arduino IDE.

  Скачать и установить необходимые программы и компоненты:
- Arduino IDE – распаковать в отдельную папку “arduino”.
https://www.arduino.cc/download_handler.php?f=/arduino-1.8.10-windows.zip

- создать папку “sketches” для хранения исходных кодов проекта.

- Запустить «arduino\arduino.exe» и в “File->Preferences->Sketchbook location” вписать путь к папке с исходными кодами (например c:\что-то-там\sketches).

- необходимые для сборки проекта библиотеки – распаковать в папку “sketches\libraries\”. Все заменять, если спросит.
https://github.com/realtim/mmb/blob/master/BTStation/libraries.zip

- Исходный код прошивки - распаковать в папку “sketches\BTStation”.
https://github.com/realtim/mmb/blob/master/BTStation/BTStation.rar

- Программа под Windows для настройки/проверки станций (запускать RFID_Station_control_win\BC_Logger_control\bin\Debug\RFID_Station_control.exe)
https://github.com/realtim/mmb/blob/master/BTStation/RFID_Station_control_win.rar

3) Подключение станции к компьютеру:
- Снять крайнюю перемычку (ближе к середине платы) и повесить её на крайний пин (чтобы не потерять)
- Соединить адаптер и станцию проводом.
- Крайний пин GND на станции немного загнут намеренно – он не используется, но на него можно случайно одеть собранный кабель.
- Соединить контакты (ориентируйтесь на цвета проводов):

Станция - Адаптер
GND - GND
VCC - 3V3
RX - TX
TX - RX
DTR - DTR

- Перед подключением адаптера к USB обязательно убедиться, что GND и VCC подключены правильно, иначе контроллер может сгореть.
- Вставить адаптер в USB. Если запросит драйвера – установить из п.1.1 .
- Узнать номер COM-порта USB-UART адаптера
- В свойствах системы
Control Panel\All Control Panel Items\System -> Device Manager -> Ports (COM, LPT) -> Silicon Labs CP210x USB to UART Bridge (COMx)
Запоминаем номер COM-порта.

4) Настроить COM-порт в ArduinoIDE

- Запустить «arduino\arduino.exe»
- Создать новый проект, вставить туда текст прошивки из п.1.4
- Настроить целевой контроллер:
- Выбрать Tools -> Board ->Arduino Pro or Pro Mini
	- Выбрать Tools -> Processor -> Atmega328P (3.3V, 8Mhz)
	- Выбрать Port -> COMx
- Номер порта выбираем в соответствии с Device Manager.
- Как вариант – посмотреть порты в «RFID_Station_control.exe» из п.1.5 .
- Запустить компиляцию и заливку прошивки Sketch -> Upload или кнопкой

Пришивка компилируется примерно до 1 минуты, потом на адаптере загораются светодиоды RX/TX секунд на 10.

После успешной компиляции и заливки должен быть примерно такая картина:

После успешной прошивки станция должна пищать ~1 секунду, как при включении.

Не отключая адаптер запустить «RFID_Station_control.exe» из п.1.5, выбрать порт, открыть и попробовать команды «Get status» и «Get config» - в текстовом окне справа должны появиться данные со станции.

Для работы со станцией через Bluetooth надо надеть перемычку обратно на 2 пина.

#### **Настройка станции**
1) Настройка основных параметров
    Описываю настройку через программу RFID_Station_control (Windows), но на Android все практически так же.
- Проверить конфигурацию станции Station->Get config
    Получаем нечто вроде:
	- Станция#: 10
	- Ответ команды: GET_CONFIG
	- Ошибка#: OK
	- Прошивка: 107
	- Режим: Init
	- Метка: 1
	- Размер флэш: 4194304 байт
	- Коэфф. пересчета температуры: 0,00589
	- Коэфф. усиления антенны: 80
	- Размер блока команды: 1024
	- Размер стираемого блока: 4096
	- Минимальное напряжение батареи: 3,000

    Нас интересуют:
	- Номер станции - не должен быть 0 или 255, номера разных станций могут быть одинаковыми и не обязательно соответствовать номерам на корпусе
	- Прошивка: 107 - для текущего ММБ должно быть именно так
	- Метка: 1 - для текущего ММБ должно быть именно так (или NTAG215)
	- Коэфф. пересчета температуры - должен соответствовать значениям в таблице https://docs.google.com/spreadsheets/d/1xguxyUE3pULNRjNZ5tdhUjNOpd881Gzgcy9woYUGa48/edit#gid=0
	- Коэфф. усиления антенны: 80 -  должен соответствовать значениям в таблице
	- Размер блока команды: 1024 - для текущего ММБ должно быть именно так
	- Размер стираемого блока: 4096 - для текущего ММБ должно быть именно так
	- Минимальное напряжение батареи: 3,000 - для текущего ММБ должно быть именно так

- Проверить имя станции, отображаемое при поиске по Bluetooth - должно соответствовать номеру на корпусе и MAC-адресу в таблице (MAC посмотреть можно в андроидной программе SENA BTerm из GooglePlay).
- Попробовать подключиться к станции и убедиться, что PIN-код именно "4892".
  Если какие-то параметры расходятся - поправить во вкладке Config

2) Калибровка усиления антенны

Цель - увеличить дистанцию работы считывателя, не ухудшая при этом надежность чтения.
- Выставляем максимальное значение усиления в настройках и, прижав чип прямо к считывателю (важно!), пробуем считать дамп чипа.
- Уменьшаем значение усиления до стабильного считывания.

#### **Тестирование чипов:**

Прошиваете тестовую прошивку в станцию и запускаете любой терминал - можно штатный ардуиновский, можно мой самодельный https://github.com/jekyll2014/ComPrnControl, можно RFID_Station_control_win.rar - любой.

У моих программ плюс - можно поставить автосохранение в файл всех пришедших данных.

Открываете порт (настройки 38400, 8 bit, Parity none, Stop bit 1) и начинаете прикладывать чипы к станции. Станция зажигает синий на время обработки чипа, мигает красным при ошибках (писк я выключил, чтобы не действовал на нервы).

По окончании теста чипа в терминал выдается отчет о тесте вида:
- UID 04:2e:f2:50:12:cf:4f:81:; 3635, OK; 508, OK; 3635, OK
- UID 04:2e:f2:50:12:cf:4f:82:; 3635, OK; 510, OK; 3633, OK
- UID 04:2e:f2:50:12:cf:4f:83:; 3634, OK; 510, OK; 3633, OK

Отчет лучше сохранить в текстовый файл для исследований.
В отчете идут по порядку:
- UID
- время записи (миллисекунды)
- кол-во ошибок записи или ОК
- время чтения(миллисекунды)
- кол-во ошибок чтения или ОК
- время очистки(миллисекунды)
- кол-во ошибок очистки или ОК
разделитель - ';' - можно импортировать как CSV для анализа результатов
